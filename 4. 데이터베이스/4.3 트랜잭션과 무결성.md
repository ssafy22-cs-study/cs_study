# 4.3 트랜잭션과 무결성

날짜: 2023년 9월 4일
발표자: ondol
태그: 데이터베이스
분류: 발표자료

## 4.3.1 트랜잭션

- 하나의 논리적 기능을 수행하기 위한 작업의 단위
- 여러 개의 쿼리를 하나로 묶는 단위

## 트랜잭션의 특징 (ACID)

### 1. **원자성(Atomicity)**

> all or nothing
> 
- 트랜잭션과 관련된 일이 모두 수행되었거나 되지 않았거나를 보장

ex)

채희가 가온에게 500만원을 보낸다. 이 말은

1. 채희의 계좌 잔액을 조회한다
2. 채희의 계좌에서 500만원을 뺀다
3. 가온의 계좌에 500만원을 넣는다

의 세 가지 쿼리가 실행되어야 한다. 이때 이 작업을 “취소(롤백)”한다고 했을 때 채희의 계좌에서 500만원이 빠져나가지 않았어야 하고, 가온도 500만원을 확인할 수 없어야 한다. 원자성은 일부 operation 즉, 채희의 계좌에서 500만원이 빠져나갔으나, 가온의 계좌에서 500만원 추가를 확인하지 못하는 경우가 없음을 보장하는 특징이다.

- 트랜잭션 단위로 여러 로직을 묶을 때 외부 API 를 호출하는 부분이 있다면, 롤백이 일어났을 때의 외부 API 롤백 작업을 반드시 고려해야 한다.

> 커밋(Commit)
> 
- 여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어
- 트랜잭션 단위로 수행
- 변경된 내용이 모두 영구적으로 저장되었음

> 롤백(Rollback)
> 
- 에러나 여러 이슈 때문에 트랜잭션 전으로 돌리는 것
- 트랜잭션으로 처리한 하나의 묶음 과정을 일어나기 전으로 돌리는 일(취소)

⇒ 커밋과 롤백 덕에 데이터의 **무결성**이 보장됨

> 커넥션
> 
- 애플리케이션과 데이터베이스의 연결
- 데이터베이스에 접속하고 접속을 종료하는 일련의 과정
- 애플리케이션은 필요로 하는 시점에 커넥션을 만드는 것이 아니라, 미리 일정한 수의 커넥션을 만들어놓고 필요한 시점에 애플리케이션에 제공 (커넥션 풀DBCP)

> 트랜잭션 전파
> 
- 여러 트랜잭션 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것

ex)

Spring 프레임워크에서 `Transactional` 어노테이션을 통해 여러 쿼리 관련 코드를 하나의 트랜잭션으로 처리

### 2. 일관성(Consistency)

> 허용된 방식으로만 데이터를 변경해야 함
> 
- 모든 데이터는 모든 상황에(트랜잭션 이전과 이후) 여러 가지 조건, 규칙에 따라 유효해야 한다

ex)

채희가 1000만원을 가지고 있고, 가온은 0원이 있다. 

가온은 채희에게 500만원을 입금할 수 없다

### 3. 격리성(Isolation)

> 모든 트랜잭션은 다른 트랜잭션으로부터 독립되어야 함(끼어들지 못함)
> 
- 막연하게 접근할 수 없다라기 보다, 일반적으로 접근의 레벨이 있고 DB에 따라 격리 레벨을 다르게 설정 가능
- 레벨을 설정함으로 격리성을 강하게, 또는 약하게 처리할 수 있음

> 격리성으로 인해 나타날 수 있는 문제점
> 
- Non-Repeatable Read
    - 한 트랜잭션 내에서 같은 Key를 가진 Row를 두 번 읽었는데 그 사이에 값이 변경되거나 삭제되어 결과가 다르게 나타나는 현상
    
    ![Untitled](4%203%20%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%E1%84%80%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%80%E1%85%A7%E1%86%AF%E1%84%89%E1%85%A5%E1%86%BC%2069572fc1f0b347fcaf5fb628c1eda9a6/Untitled.png)
    
- Phantom Read
    - Non-Repeatable Read의 한 종류
    - 한 트랜잭션 내에서 같은 쿼리를 두 번 수행했는데, 첫 번째 쿼리에서 없던 레코드가 두 번째 쿼리에서 나타나는 현상 (유령(Phantom) 처럼!!)
    
    ![Untitled](4%203%20%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%E1%84%80%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%80%E1%85%A7%E1%86%AF%E1%84%89%E1%85%A5%E1%86%BC%2069572fc1f0b347fcaf5fb628c1eda9a6/Untitled%201.png)
    
- Dirty Read
    - 특정 트랜잭션에 의해 데이터가 변경되었지만, 아직 커밋되지 않은 상황에서 다른 트랜잭션이 해당 변경 사항을 조회할 수 있는 문제
    
    ![Untitled](4%203%20%E1%84%90%E1%85%B3%E1%84%85%E1%85%A2%E1%86%AB%E1%84%8C%E1%85%A2%E1%86%A8%E1%84%89%E1%85%A7%E1%86%AB%E1%84%80%E1%85%AA%20%E1%84%86%E1%85%AE%E1%84%80%E1%85%A7%E1%86%AF%E1%84%89%E1%85%A5%E1%86%BC%2069572fc1f0b347fcaf5fb628c1eda9a6/Untitled%202.png)
    

> **격리 수준**
> 
- ****SERIALIZABLE****
    - 특정 트랜잭션이 사용중인 테이블의 “모든 행”을 다른 트랜잭션이 접근할 수 없도록 잠금
    - 가장 높은 데이터 정합성을 갖으나, 성능은 가장 떨어짐
    - 단순한 SELECT 쿼리가 실행되더라도, 락이 걸려 다른 트랜잭션에서 데이터에 접근할 수 없음
- **REPEATABLE_READ**
    - 특정 행을 조회 시 항상 같은 데이터를 응답하는 것을 보장하는 격리 수준
    - 그러나 SERIALIZABLE과 다르게 행이 추가되는 것을 막지는 않음
    - 발생할 수 있는 문제
        - 팬텀 리드
- **READ_COMMITTED**
    - 커밋이 완료된 트랜잭션의 변경사항만 다른 트랜잭션에서 조회할 수 있도록 허용 
    ⇒ 커밋 완료된 데이터에 대해서만 조회를 허용
    - 발생할 수 있는 문제
        - 팬텀 리드
        - 반복 가능하지 않은 조회
- **READ_UNCOMMITTED**
    - 커밋이 되지 않은 트랜잭션의 데이터 변경 내용 조회를 허용
    - 데이터 부정합 문제가 발생할 확률이 높지만, 성능이 가장 빠름
    - 데이터를 “어림잡아” 집계하는 등의 연산에서 사용하면 좋음
    - 발생할 수 있는 문제
        - 더티 리드
        - 반복 가능하지 않은 조회
        - 팬텀 리드

### 4. 지속성(Durability)

- 성공적으로 수행된 트랜잭션은 영원히 반영되어야 함
= 시스템 장애가 발생했을 때를 대비해 회복 기능이 있어야 함
- 이를 위해 데이터베이스는 체크섬, 저널링, 롤백 등의 기능을 제공
    - 체크섬?
        - 중복 검사의 한 형태
        - 나열된 데이터를 더하여 체크섬 숫자를 얻고, 정해진 비트수의 모듈라로 비트를 재구성하여 무결성 검사에 대해 비교, 그 값을 통해 데이터가 손상되지 않았음을 확인
    - 저널링?
        - 파일 시스템 또는 데이터베이스 시스템에 변경 사항을 커밋하기 전에 로깅하는 것
        - 트랜잭션 등 변경 사항에 대한 로그를 남기는 것

---

## 4.3.2 무결성

- 데이터의 정확성, 일관성, 유효성을 유지하는 것
- 무결성의 유지 = DB에 저장된 값과 그 값에 해당하는 실제 값이 일치하는가에 대한 신뢰도

## 무결성 종류

|      이름     |                                                       설명                                                      |
|:-------------:|:---------------------------------------------------------------------------------------------------------------:|
| 개체 무결성   | (기본키 관련)  1. 모든 테이블은 기본키를 가져야 함 / 2. 기본키로 선택된 필드는 고유하여야 하며, 빈 값을 허용하지 X |
| 참조 무결성   | (외래키 관련)  1. 서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지                               |
| 고유 무결성   | 특정 속성에 대해 고유한 값을 가지도록 조건이 주어진 경우, 그 속성 값은 모두 고유한 값을 가짐                    |
| NULL 무결성   | 특정 속성 값에 NULL이 올 수 없다는 조건이 주어진 경우 그 속성 값은 NULL이 될 수 없음                            |
| 도메인 무결성 | 데이터는 지정된 타입에 맞아야 함                                                                                |